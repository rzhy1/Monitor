name: Monitor ZTB Changes

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # 每小时执行一次

jobs:
  check_url_changes:
    runs-on: ubuntu-latest

    env:
      SCKEY: ${{ secrets.SCTKEY }}  # Server酱的 SCKEY，存储在 GitHub Secrets 中
      CHECK_URLS: |
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=2331
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=2332
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3508
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3509
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3510
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3511
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3512

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Check for URL changes
        id: check_changes
        run: |
          python - <<EOF
          import os
          import json
          import hashlib
          import requests

          # 定义请求头，模拟浏览器行为
          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
          }

          # 获取所有需要检查的 URL
          urls = os.getenv("CHECK_URLS").splitlines()
          state_file = os.path.join(os.environ['GITHUB_WORKSPACE'], 'url_state.json')

          # 读取之前的哈希状态
          previous_states = {}
          if os.path.exists(state_file):
              with open(state_file, 'r') as f:
                  previous_states = json.load(f)

          current_states = {}
          changed_urls = []

          for url in urls:
              try:
                  # 使用自定义请求头发起请求
                  response = requests.get(url, headers=headers, timeout=10)
                  response.raise_for_status()
                  content = response.text
                  hash_value = hashlib.md5(content.encode('utf-8')).hexdigest()

                  current_states[url] = hash_value
                  if url in previous_states and previous_states[url] != hash_value:
                      changed_urls.append(url)
              except Exception as e:
                  print(f"Error checking URL {url}: {e}")

          # 如果有变化，发送通知
          if changed_urls:
              message = "以下链接的内容发生了变化：\n" + "\n".join(changed_urls)
              print(message)

              # 发送通知到 Server酱
              sckey = os.getenv("SCTKEY")
              if sckey:
                  notify_url = f"https://sctapi.ftqq.com/{sckey}.send"
                  data = {
                      "text": "招标信息更新",
                      "desp": message
                  }
                  requests.post(notify_url, data=data)

          # 保存当前状态
          with open(state_file, 'w') as f:
              json.dump(current_states, f)
          EOF

      - name: Commit state file if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if git diff --quiet; then
              echo "No changes to commit."
          else
              git add url_state.json
              git commit -m "Update URL states"
              git push
          fi
