name: Monitor URL Changes

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/monitor.yml'
      - 'url_state.json'
  schedule:
    - cron: '0 23,0-13 * * *'

permissions:
  contents: write

jobs:
  check_url_changes:
    runs-on: ubuntu-latest
    env:
      WEBHOOK_URLS: ${{ secrets.WEBHOOK_URLS }}
      CHECK_URLS: |
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=2331
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=2332
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3508
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3509
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3510
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3511
        https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3512
      URL_DESCRIPTIONS: |
        {
          "https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=2331": "æ­å·åœ°é“æ‹›æ ‡è®¡åˆ’å‘å¸ƒ",
          "https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=2332": "æ­å·åœ°é“æ‹›æ ‡é¢„å…¬ç¤º",
          "https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3508": "æ­å·åœ°é“ç‰¹åˆ«æé†’é¡¹ç›®",
          "https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3509": "æ­å·åœ°é“æ‹›æ ‡æ ¸å‡†é¡¹ç›®",
          "https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3510": "æ­å·åœ°é“æ‹›æ ‡æ–‡ä»¶å…¬ç¤º",
          "https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3511": "æ­å·åœ°é“ä¸­æ ‡å…¬ç¤º",
          "https://ztb.cxjw.hangzhou.gov.cn:8092/search/queryContents.jhtml?titleOrCode=%E5%9F%8E%E5%B8%82%E8%BD%A8%E9%81%93%E4%BA%A4%E9%80%9A&status=5&channelId=3512": "æ­å·åœ°é“ä¸­æ ‡ç»“æœ"
        }

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - run: pip install requests beautifulsoup4 urllib3

      - name: Check and notify
        run: |
          python - << "EOF"
          import os, json, re, time, hashlib, requests
          from bs4 import BeautifulSoup
          from requests.adapters import HTTPAdapter
          from urllib3.util.retry import Retry

          STATE_FILE = "url_state.json"
          BASE = "https://ztb.cxjw.hangzhou.gov.cn:8092"

          def session():
              s = requests.Session()
              r = Retry(total=3, backoff_factor=1, status_forcelist=[429,500,502,503,504])
              s.mount("http", HTTPAdapter(max_retries=r))
              s.mount("https", HTTPAdapter(max_retries=r))
              return s

          def send_wecom(webhook, content):
              r = requests.post(
                  webhook,
                  json={"msgtype": "markdown", "markdown": {"content": content}},
                  timeout=10
              )
              r.raise_for_status()

          def parse_items(html):
              soup = BeautifulSoup(html, "html.parser")
              items = {}
              for d in soup.select("div.menu.menu_time"):
                  onclick = d.get("onclick", "")
                  m = re.search(r"detailId=(\d+)", onclick)
                  if not m:
                      continue
                  did = m.group(1)
                  title = d.get_text(strip=True)
                  url = f"{BASE}/detail.jhtml?detailId={did}"
                  items[did] = {"title": title, "url": url}
              return items

          urls = [u for u in os.getenv("CHECK_URLS","").splitlines() if u.strip()]
          descs = json.loads(os.getenv("URL_DESCRIPTIONS","{}"))
          webhooks = [w for w in os.getenv("WEBHOOK_URLS","").splitlines() if w.strip()]
          s = session()

          try:
              state = json.load(open(STATE_FILE))
          except:
              state = {}

          new_state = {}
          notify = {}

          print("=== å¼€å§‹æ£€æµ‹ URL æ›´æ–° ===")
          for url in urls:
              print(f"\nğŸ” æ£€æŸ¥ URL: {url}")
              try:
                  html = s.get(url, timeout=10).text
                  items = parse_items(html)
                  ids = sorted(items.keys())
                  h = hashlib.sha256("\n".join(ids).encode()).hexdigest()

                  old = set(state.get(url, {}).get("ids", []))
                  added = [items[i] for i in ids if i not in old]

                  new_state[url] = {"hash": h, "ids": ids}

                  print(f"  æ€»å…¬å‘Šæ•°é‡: {len(ids)}")
                  print(f"  æ–°å¢å…¬å‘Šæ•°é‡: {len(added)}")
                  if state.get(url, {}).get("hash") != h:
                      print(f"  å“ˆå¸Œå€¼å˜åŒ–: {state.get(url, {}).get('hash')} -> {h}")

                  if added:
                      notify[url] = added

              except Exception as e:
                  print(f"  âŒ è¯·æ±‚æˆ–è§£æå¤±è´¥: {e}")

              time.sleep(1)

          if notify:
              print("\n=== æ£€æµ‹åˆ°æ–°å¢å…¬å‘Šï¼Œå‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥ ===")
              for u, items in notify.items():
                  lines = [f"### ğŸ“¢ {descs.get(u,u)} æœ‰æ–°å…¬å‘Š"]
                  for i in items:
                      lines.append(f"- [{i['title']}]({i['url']})")
                  content = "\n".join(lines)

                  for wh in webhooks:
                      try:
                          send_wecom(wh, content)
                          print(f"  âœ… å·²å‘é€é€šçŸ¥åˆ° {wh}")
                      except Exception as e:
                          print(f"  âŒ å‘é€é€šçŸ¥å¤±è´¥: {e}")
          else:
              print("\nâœ… æœªæ£€æµ‹åˆ°ä»»ä½•æ–°å¢å…¬å‘Š")

          json.dump(new_state, open(STATE_FILE,"w"), indent=2, ensure_ascii=False)
          print("\n=== URL æ£€æµ‹å®Œæˆï¼ŒçŠ¶æ€æ–‡ä»¶å·²æ›´æ–° ===")
          EOF

      - name: Commit state
        run: |
          git config --global user.name github-actions[bot]
          git config --global user.email github-actions[bot]@users.noreply.github.com
          git add url_state.json
          git commit -m "Update URL states" || true
          git push || true
